This patch makes SQLite 2.8.0 more robust against
locale (LC_NUMERIC) differences in floating point
string representation. Apply it on a stock 2.8.0
SQLite source tree.

diff -ur sqlite.orig/configure.ac sqlite/configure.ac
--- sqlite.orig/configure.ac	Fri Sep 28 03:34:45 2001
+++ sqlite/configure.ac	Sat May  3 19:57:31 2003
@@ -472,6 +472,11 @@
 AC_CHECK_FUNC(usleep, [TARGET_CFLAGS="$TARGET_CFLAGS -DHAVE_USLEEP=1"])
 
 #########
+# Figure out whether or not we have a "localeconv()" function.
+#
+AC_CHECK_FUNC(localeconv, [TARGET_CFLAGS="$TARGET_CFLAGS -DHAVE_LOCALECONV=1"])
+
+#########
 # Generate the output files.
 #
 AC_OUTPUT(Makefile)
diff -ur sqlite.orig/src/func.c sqlite/src/func.c
--- sqlite.orig/src/func.c	Mon Nov  4 20:32:25 2002
+++ sqlite/src/func.c	Sat May  3 21:33:45 2003
@@ -150,6 +150,9 @@
   if( n<0 ) n = 0;
   r = atof(argv[0]);
   sprintf(zBuf,"%.*f",n,r);
+#if OS_WIN || defined(HAVE_LOCALECONV)
+  sqliteFixupFloat(zBuf);
+#endif
   sqlite_set_result_string(context, zBuf, -1);
 }
 
diff -ur sqlite.orig/src/sqliteInt.h sqlite/src/sqliteInt.h
--- sqlite.orig/src/sqliteInt.h	Sun Feb 16 23:21:32 2003
+++ sqlite/src/sqliteInt.h	Sat May  3 21:53:40 2003
@@ -1049,3 +1049,8 @@
 # define sqliteAuthRead(a,b,c,d)
 # define sqliteAuthCheck(a,b,c,d)    SQLITE_OK
 #endif
+#if OS_WIN || defined(HAVE_LOCALECONV)
+double sqliteAtof(const char*);
+#define atof(x) sqliteAtof(x)
+void sqliteFixupFloat(char*);
+#endif
diff -ur sqlite.orig/src/util.c sqlite/src/util.c
--- sqlite.orig/src/util.c	Sun Feb 16 23:21:32 2003
+++ sqlite/src/util.c	Sat May  3 21:54:30 2003
@@ -19,6 +19,9 @@
 #include "sqliteInt.h"
 #include <stdarg.h>
 #include <ctype.h>
+#if OS_WIN || defined(HAVE_LOCALECONV)
+#include <locale.h>
+#endif
 
 /*
 ** If malloc() ever fails, this global variable gets set to 1.
@@ -1204,3 +1207,55 @@
   }
   return 0;
 }
+
+#if OS_WIN || defined(HAVE_LOCALECONV)
+
+/* Local atof() replacement function to work around LC_NUMERIC
+** differences with respect to decimal point.
+** CAUTION: passed string is temporarily modified !!!
+*/
+
+#undef atof
+
+double sqliteAtof(const char *atext){
+  struct lconv *lc;
+  char *dp = NULL;
+  double value;
+
+  lc = localeconv();
+  if( lc!=0 &&
+      lc->decimal_point!=0 &&
+      lc->decimal_point[0] &&
+      lc->decimal_point[0]!='.' ){
+    dp = strchr(atext,'.');
+    if( dp!=0 ){
+      *dp = lc->decimal_point[0];
+    }
+  }
+  value = atof(atext);
+  if( dp!=0 ){
+    *dp = '.';
+  }
+  return value;
+}
+
+/* Function to restore dot as decimal point after using
+** locale specific sprintf %e, %f, %g formats.
+*/
+
+void sqliteFixupFloat(char *atext){
+  struct lconv *lc;
+  char *p;
+
+  lc = localeconv();
+  if( lc!=0 &&
+      lc->decimal_point!=0 &&
+      lc->decimal_point[0] &&
+      lc->decimal_point[0]!='.' ){
+    p = strchr(atext,lc->decimal_point[0]);
+    if( p ){
+      *p = '.';
+    }
+  }
+}
+#endif
diff -ur sqlite.orig/src/vdbe.c sqlite/src/vdbe.c
--- sqlite.orig/src/vdbe.c	Sun Feb 16 23:21:32 2003
+++ sqlite/src/vdbe.c	Sat May  3 21:32:55 2003
@@ -905,6 +905,9 @@
   int fg = pStack->flags;
   if( fg & STK_Real ){
     sprintf(pStack->z,"%.15g",pStack->r);
+#if OS_WIN || defined(HAVE_LOCALECONV)
+    sqliteFixupFloat(pStack->z);
+#endif
   }else if( fg & STK_Int ){
     sprintf(pStack->z,"%d",pStack->i);
   }else{
